<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Catalog</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #D4AF37;
            --secondary-text: #a0a0a0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --blur-strength: 8px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        #toast-container {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(var(--blur-strength));
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 14px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            animation: fadeInOut 2.5s ease forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }

        .header {
            padding: 20px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .logo { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; color: var(--accent-color); }
        
        #city-selector {
            background: var(--card-bg);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #333;
        }

        .filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 0 16px 15px;
            scrollbar-width: none;
        }
        .filters::-webkit-scrollbar { display: none; }

        .filter-btn {
            background: var(--card-bg);
            color: var(--secondary-text);
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 20px;
            white-space: nowrap;
            font-size: 14px;
            transition: 0.2s;
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: black;
            border-color: var(--accent-color);
        }

        .product-list { padding: 0 16px; }

        .product-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #2a2a2a;
        }

        .product-info { flex: 1; }
        .product-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .product-price { color: var(--accent-color); font-weight: 700; font-size: 15px; }
        .product-unit { font-size: 12px; color: var(--secondary-text); font-weight: 400; }

        .btn {
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn {
            background: #2a2a2a;
            color: var(--accent-color);
            padding: 10px 16px;
            font-size: 14px;
        }
        .add-btn:active { transform: scale(0.95); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(25, 25, 25, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid #333;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            font-size: 11px;
            gap: 4px;
            transition: 0.2s;
            position: relative;
        }

        .nav-item.active { color: var(--accent-color); }
        
        .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .view { display: none; padding-bottom: 20px; }
        .view.active { display: block; }

        /* СТИЛИ КОРЗИНЫ */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .qty-controls { display: flex; align-items: center; gap: 12px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; background: #333; color: white; display: flex; align-items: center; justify-content: center; }

        .order-section {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 16px;
            margin-top: 20px;
        }

        input {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            outline: none;
        }

        .submit-btn {
            background: var(--accent-color);
            color: black;
            width: 100%;
            padding: 14px;
            font-size: 16px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="header">
        <div class="logo">ARMOTEK</div>
        <div id="city-selector" onclick="toggleCityList()">Москва ▼</div>
    </div>

    <div id="catalog-filters" class="filters">
        <button class="filter-btn active" onclick="filterCat('all', this)">Все</button>
        <button class="filter-btn" onclick="filterCat('nar', this)">NAR PPF</button>
        <button class="filter-btn" onclick="filterCat('crystal', this)">Crystal</button>
    </div>

    <div id="catalog-view" class="view active">
        <div id="product-list" class="product-list"></div>
    </div>

    <div id="cart-view" class="view">
        <div class="container" style="padding: 0 16px;">
            <h3 style="margin-top:0">Мой заказ</h3>
            <div id="cart-items"></div>
            
            <div id="cart-empty" style="text-align:center; padding: 40px 0; color: var(--secondary-text); display:none;">
                Корзина пуста
            </div>

            <div id="cart-footer" class="order-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; font-size:18px;">
                    <span>Итого:</span>
                    <span id="total-price">0 ₽</span>
                </div>
                
                <input type="text" id="cust-name" placeholder="Ваше имя">
                <input type="text" id="cust-phone" placeholder="Телефон">
                <input type="text" id="cust-studio" placeholder="Название студии">
                
                <div style="display:flex; gap:10px;">
                    <input type="text" id="addr-street" placeholder="Улица">
                    <input type="text" id="addr-house" placeholder="Дом">
                </div>
                
                <button class="btn submit-btn" onclick="submitOrder()">Оформить заказ</button>
            </div>
        </div>
    </div>

    <div id="profile-view" class="view">
        <div class="container" style="padding: 0 16px;">
            <div class="order-section">
                <div id="user-info">
                    <h3 id="profile-name">Пользователь</h3>
                    <p id="profile-role" style="color:var(--accent-color); margin: -10px 0 15px 0;">Розничный клиент</p>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Город:</span>
                    <span id="profile-city">Москва</span>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('catalog-view', this)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Каталог
        </div>
        <div class="nav-item" onclick="switchTab('cart-view', this)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            Корзина <span id="cart-badge" class="badge" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile-view', this)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Профиль
        </div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. ОПРЕДЕЛЕНИЕ РОЛИ ИЗ URL (БЛОК D)
        const urlParams = new URLSearchParams(window.location.search);
        const isDealerFromBot = urlParams.get('isDealer') === 'true';

        let cart = [];
        let currentCat = 'all';
        let userProfile = JSON.parse(localStorage.getItem('armotek_profile')) || {
            city: 'Москва',
            isDealer: isDealerFromBot
        };

        // ТОВАРЫ (ID ДОЛЖНЫ СОВПАДАТЬ С ПИТОНОМ)
        const products = [
            { id: 101, name: "NAR PPF H190", price: 45000, dealer_price: 38000, unit: "рул.", category: "nar" },
            { id: 102, name: "NAR PPF H190 (отрез)", price: 3500, dealer_price: 2900, unit: "пог.м.", category: "nar" },
            { id: 103, name: "NAR PPF H210", price: 52000, dealer_price: 45000, unit: "рул.", category: "nar" },
            { id: 104, name: "NAR PPF Matte", price: 48000, dealer_price: 41000, unit: "рул.", category: "nar" },
            { id: 201, name: "Crystal Premium 215", price: 28000, dealer_price: 22000, unit: "рул.", category: "crystal" },
            { id: 202, name: "Crystal Matte", price: 30000, dealer_price: 24000, unit: "рул.", category: "crystal" }
        ];

        function init() {
            document.getElementById('city-selector').innerText = userProfile.city + ' ▼';
            document.getElementById('profile-city').innerText = userProfile.city;
            document.getElementById('profile-role').innerText = isDealerFromBot ? 'Дилер' : 'Розничный клиент';
            if (tg.initDataUnsafe?.user) {
                document.getElementById('profile-name').innerText = tg.initDataUnsafe.user.first_name;
            }
            renderProducts();
        }

        function renderProducts() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            const filtered = currentCat === 'all' ? products : products.filter(p => p.category === currentCat);
            
            filtered.forEach(p => {
                // ВЫБОР ЦЕНЫ (БЛОК A3)
                const price = isDealerFromBot ? p.dealer_price : p.price;
                
                list.innerHTML += `
                    <div class="product-card">
                        <div class="product-info">
                            <div class="product-name">${p.name}</div>
                            <div class="product-price">${price.toLocaleString()} ₽ <span class="product-unit">/ ${p.unit}</span></div>
                        </div>
                        <button class="btn add-btn" onclick="addToCart(${p.id})">В корзину</button>
                    </div>
                `;
            });
        }

        function filterCat(cat, btn) {
            currentCat = cat;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderProducts();
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const inCart = cart.find(x => x.id === id);
            if (inCart) {
                inCart.qty++;
            } else {
                cart.push({ ...p, qty: 1 });
            }
            showToast('Добавлено в корзину');
            updateCartUI();
        }

        function updateCartUI() {
            const count = cart.reduce((a, b) => a + b.qty, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        }

        function renderCart() {
            const itemsCont = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            const empty = document.getElementById('cart-empty');
            
            if (cart.length === 0) {
                itemsCont.innerHTML = '';
                footer.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            footer.style.display = 'block';
            itemsCont.innerHTML = '';

            let total = 0;
            cart.forEach(item => {
                const price = isDealerFromBot ? item.dealer_price : item.price;
                const cost = price * item.qty;
                total += cost;
                
                itemsCont.innerHTML += `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight:600">${item.name}</div>
                            <div style="color:var(--accent-color); font-size:14px">${cost.toLocaleString()} ₽</div>
                        </div>
                        <div class="qty-controls">
                            <div class="qty-btn" onclick="changeQty(${item.id}, -1)">−</div>
                            <span>${item.qty}</span>
                            <div class="qty-btn" onclick="changeQty(${item.id}, 1)">+</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('total-price').innerText = total.toLocaleString() + ' ₽';
        }

        function changeQty(id, delta) {
            const item = cart.find(x => x.id === id);
            item.qty += delta;
            if (item.qty <= 0) cart = cart.filter(x => x.id !== id);
            renderCart();
            updateCartUI();
        }

        function submitOrder() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;

            if (!name || !phone || cart.length === 0) {
                showToast('Заполните контакты!', 'error');
                return;
            }

            const payload = {
                order: {
                    cart: cart.map(i => ({ id: i.id, qty: i.qty })),
                    customer: {
                        name: name,
                        phone: phone,
                        studio: document.getElementById('cust-studio').value,
                        city: userProfile.city
                    }
                },
                _auth: tg.initData // ОБЯЗАТЕЛЬНО ДЛЯ ВАЛИДАЦИИ В БОТЕ
            };

            if (tg.initData) {
                tg.sendData(JSON.stringify(payload));
                tg.close();
            } else {
                showToast('Ошибка: Запустите через Telegram', 'error');
            }
        }

        function switchTab(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            document.getElementById('catalog-filters').style.display = viewId === 'catalog-view' ? 'flex' : 'none';
            if (viewId === 'cart-view') renderCart();
        }

        function showToast(text, type = 'success') {
            const cont = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'error') toast.style.borderColor = 'var(--danger)';
            toast.innerText = text;
            cont.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function toggleCityList() {
            const cities = ['Москва', 'СПб', 'Краснодар', 'Екатеринбург', 'Казань'];
            const newCity = prompt("Выберите город: " + cities.join(', '), userProfile.city);
            if (newCity && cities.includes(newCity)) {
                userProfile.city = newCity;
                localStorage.setItem('armotek_profile', JSON.stringify(userProfile));
                init();
            }
        }

        init();
    </script>
</body>
</html>
