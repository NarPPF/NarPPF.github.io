<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=776970988-YOUR-KEY" type="text/javascript"></script>
    
    <style>
        :root { --accent: #D4AF37; --bg: #000; --card: #111; --text: #fff; }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            margin: 0; padding-bottom: 80px; overflow-x: hidden; 
        }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .app-bar { 
            display: flex; align-items: center; padding: 15px; 
            background: rgba(0,0,0,0.9); border-bottom: 1px solid #222; 
            position: sticky; top: 0; z-index: 1000; 
        }
        .back-btn { background: none; border: none; color: var(--accent); font-size: 24px; display: none; padding-right: 15px; cursor: pointer; }
        .back-btn.visible { display: block; }
        .page-title { font-weight: bold; font-size: 18px; }

        /* –í—å—é—Ö–∏ */
        .view { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #222; }
        .main-btn { 
            background: var(--accent); color: #000; width: 100%; padding: 16px; 
            border-radius: 12px; font-weight: bold; border: none; cursor: pointer; font-size: 16px;
        }
        .main-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        input { 
            width: 100%; padding: 14px; background: #1a1a1a; color: #fff; 
            border: 1px solid #333; border-radius: 10px; margin-top: 5px; 
            box-sizing: border-box; font-size: 16px; /* 16px —á—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª */
        }

        /* --- –ù–û–í–´–ô –î–ò–ó–ê–ô–ù –ö–ê–†–¢–´ --- */
        #map-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 5000; 
        }
        /* –ü–æ–∏—Å–∫ —Å–≤–µ—Ä—Ö—É (—á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞) */
        .map-search-panel {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 15px; background: rgba(0,0,0,0.9); z-index: 5002;
            box-sizing: border-box; border-bottom: 1px solid #333;
        }
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 5001; }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–Ω–∏–∑—É */
        .map-confirm-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px; background: linear-gradient(to top, #000 80%, transparent); 
            z-index: 5002; box-sizing: border-box; display: flex; gap: 10px;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-bottom { 
            position: fixed; bottom: 0; width: 100%; display: flex; 
            background: #0a0a0a; border-top: 1px solid #222; 
            padding-bottom: env(safe-area-inset-bottom); z-index: 1000;
        }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #555; background: none; border: none; font-size: 10px; letter-spacing: 1px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
    </style>
</head>
<body>

    <div class="app-bar">
        <button id="back-btn" class="back-btn" onclick="goBack()">‚ùÆ</button>
        <div id="page-title" class="page-title">Armotek</div>
    </div>

    <div id="catalog-view" class="view active">
        <div id="products-grid"></div>
    </div>

    <div id="cart-view" class="view">
        <div id="cart-list"></div>
        
        <div id="order-form" style="display:none; margin-top:20px;">
            <div class="card">
                <label style="color:var(--accent); font-size:12px; font-weight:bold;">–ê–î–†–ï–° –î–û–°–¢–ê–í–ö–ò</label>
                <div onclick="openMap()" style="margin-top:10px; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                    <span id="display-addr" style="color:#aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ...</span>
                    <span style="font-size:18px;">üó∫</span>
                </div>
            </div>
            <button id="order-btn" class="main-btn" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <div id="profile-view" class="view">
        <div class="card">
            <h3>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <label style="font-size:12px; color:#888;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="u-phone" placeholder="+7..." onchange="saveLocalProfile()">
            
            <label style="font-size:12px; color:#888; display:block; margin-top:15px;">–ì–æ—Ä–æ–¥ (–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</label>
            <input type="text" id="u-city" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ..." onchange="saveLocalProfile()">
        </div>
    </div>

    <div id="map-overlay">
        <div class="map-search-panel">
            <div style="display:flex; gap:10px;">
                <input type="text" id="map-search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, —É–ª–∏—Ü—É..." style="margin:0;">
                <button onclick="searchOnMap()" style="background:var(--accent); border:none; border-radius:10px; width:50px; font-weight:bold;">üîç</button>
            </div>
            <div style="font-size:11px; color:#888; margin-top:5px;">–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –¢–≤–µ—Ä—Å–∫–∞—è 1</div>
        </div>

        <div id="map"></div>

        <div class="map-confirm-panel">
            <button onclick="closeMap(false)" style="flex:1; background:#222; color:#fff; border:none; padding:15px; border-radius:12px; font-weight:bold;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="closeMap(true)" style="flex:2; background:var(--accent); color:#000; border:none; padding:15px; border-radius:12px; font-weight:bold;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>

    <nav class="nav-bottom">
        <button class="nav-item active" onclick="navigate('catalog-view')">–ö–ê–¢–ê–õ–û–ì</button>
        <button class="nav-item" onclick="navigate('cart-view')">–ö–û–†–ó–ò–ù–ê</button>
        <button class="nav-item" onclick="navigate('profile-view')">–ü–†–û–§–ò–õ–¨</button>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let cart = [];
        let stack = ['catalog-view'];
        let selectedAddress = "";
        let selectedCity = "";
        let mapInstance = null;
        let mapPlacemark = null;

        // –¢–æ–≤–∞—Ä—ã
        const products = [
            {id: 1, name: "Armotek Onyx (1.52m)", price: 15900, img: "https://via.placeholder.com/100"},
            {id: 2, name: "Armotek Matte (1.52m)", price: 17200, img: "https://via.placeholder.com/100"},
            {id: 3, name: "–†–∞–∫–µ–ª—å Carbon", price: 2500, img: "https://via.placeholder.com/100"}
        ];

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        function init() {
            renderCatalog();
            loadLocalProfile();
        }

        // --- –ö–ê–¢–ê–õ–û–ì –ò –ö–û–†–ó–ò–ù–ê ---
        function renderCatalog() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = products.map(p => `
                <div class="card" style="display:flex; gap:15px; align-items:center;">
                    <div style="width:60px; height:60px; background:#222; border-radius:8px;"></div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="color:var(--accent);">${p.price} ‚ÇΩ</div>
                    </div>
                    <button class="main-btn" style="width:auto; padding:8px 15px;" onclick="addToCart(${p.id})">+</button>
                </div>
            `).join('');
        }

        function addToCart(id) {
            const p = products.find(i => i.id === id);
            cart.push(p);
            tg.HapticFeedback.impactOccurred('light');
            renderCart();
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            alert("–î–æ–±–∞–≤–ª–µ–Ω–æ: " + p.name); 
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const form = document.getElementById('order-form');
            
            if(cart.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:50px; color:#555;'>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>";
                form.style.display = 'none';
            } else {
                let total = cart.reduce((sum, i) => sum + i.price, 0);
                list.innerHTML = cart.map(i => `
                    <div style="padding:10px; border-bottom:1px solid #222; display:flex; justify-content:space-between;">
                        <span>${i.name}</span>
                        <span>${i.price} ‚ÇΩ</span>
                    </div>
                `).join('') + `<div style="text-align:right; padding:15px; font-weight:bold; color:var(--accent)">–ò–¢–û–ì–û: ${total} ‚ÇΩ</div>`;
                form.style.display = 'block';
            }
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function navigate(viewId) {
            if (stack[stack.length - 1] === viewId) return;
            stack.push(viewId);
            updateView();
        }

        function goBack() {
            if (stack.length > 1) { stack.pop(); updateView(); }
        }

        function updateView() {
            const current = stack[stack.length - 1];
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(current).classList.add('active');
            
            document.getElementById('back-btn').classList.toggle('visible', stack.length > 1);
            document.getElementById('page-title').innerText = 
                current === 'catalog-view' ? 'Armotek Store' : 
                current === 'cart-view' ? '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ' : '–ü—Ä–æ—Ñ–∏–ª—å';

            document.querySelectorAll('.nav-item').forEach(btn => {
                const target = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                btn.classList.toggle('active', target === current);
            });
        }

        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢–´ (FIXED) ---
        function openMap() {
            document.getElementById('map-overlay').style.display = 'block';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (!mapInstance) {
                ymaps.ready(initMapEngine);
            } else {
                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ –µ—Å—Ç—å, —Ä–µ—Å–∞–π–∑–∏–º –µ—ë (–≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ display:none)
                mapInstance.container.fitToViewport();
            }
        }

        function initMapEngine() {
            mapInstance = new ymaps.Map("map", {
                center: [55.751574, 37.573856],
                zoom: 11,
                controls: ['zoomControl', 'geolocationControl'] // –î–æ–±–∞–≤–∏–ª–∏ –∫–Ω–æ–ø–∫—É "–ì–¥–µ —è"
            });

            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
            mapInstance.events.add('click', function (e) {
                const coords = e.get('coords');
                setMapMarker(coords);
            });
            
            // –°–ª—É—à–∞–µ–º –∫–Ω–æ–ø–∫—É "–ì–¥–µ —è" —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ
            // –Ø–Ω–¥–µ–∫—Å —Å–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª, 
            // –Ω–æ –º—ã –º–æ–∂–µ–º –ø–æ–≤–µ—Å–∏—Ç—å –ª–∏—Å—Ç–µ–Ω–µ—Ä –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –∏–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –∏ –ø–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞
        function setMapMarker(coords) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
            if (mapPlacemark) {
                mapInstance.geoObjects.remove(mapPlacemark);
            }
            
            // –°—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π
            mapPlacemark = new ymaps.Placemark(coords, {}, {
                preset: 'islands#yellowIcon',
                draggable: true // –ú–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å!
            });
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏–ª–∏ –º–∞—Ä–∫–µ—Ä
            mapPlacemark.events.add('dragend', function () {
                getAddress(mapPlacemark.geometry.getCoordinates());
            });

            mapInstance.geoObjects.add(mapPlacemark);
            getAddress(coords);
        }

        // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -> –ê–¥—Ä–µ—Å + –ì–æ—Ä–æ–¥)
        function getAddress(coords) {
            document.getElementById('map-search-input').value = "–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...";
            
            ymaps.geocode(coords).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                
                // –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å
                const address = firstGeoObject.getAddressLine();
                
                // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã—Ç–∞—â–∏—Ç—å –≥–æ—Ä–æ–¥ (Locality)
                const localities = firstGeoObject.getLocalities(); 
                const city = localities.length > 0 ? localities[0] : "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                selectedAddress = address;
                selectedCity = city;

                // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ –ø–æ–∏—Å–∫–µ
                document.getElementById('map-search-input').value = address;
            });
        }

        // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –ø–æ–ª—é (–ö–Ω–æ–ø–∫–∞ –õ—É–ø–∞)
        function searchOnMap() {
            const query = document.getElementById('map-search-input').value;
            if (!query) return;

            ymaps.geocode(query).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                if (!firstGeoObject) {
                    alert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    return;
                }
                const coords = firstGeoObject.geometry.getCoordinates();
                
                mapInstance.setCenter(coords, 15);
                setMapMarker(coords);
            });
        }

        function closeMap(save) {
            document.getElementById('map-overlay').style.display = 'none';
            if (save && selectedAddress) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –∑–∞–∫–∞–∑–∞
                document.getElementById('display-addr').innerText = selectedAddress;
                document.getElementById('display-addr').style.color = "#fff";
                
                // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ü–û–î–¢–Ø–ì–ò–í–ê–ï–ú –ì–û–†–û–î –í –ü–†–û–§–ò–õ–¨
                document.getElementById('u-city').value = selectedCity;
                saveLocalProfile(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                
                alert(`–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω!\n–ì–æ—Ä–æ–¥ (${selectedCity}) —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª—å.`);
            }
        }

        // --- –ó–ê–ö–ê–ó –ò –ü–†–û–§–ò–õ–¨ ---
        function sendOrder() {
            if (!selectedAddress) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏!");
                return;
            }
            
            const total = cart.reduce((sum, i) => sum + i.price, 0);
            const data = {
                cart: cart,
                total: total,
                address: selectedAddress,
                city: document.getElementById('u-city').value,
                phone: document.getElementById('u-phone').value
            };
            
            tg.sendData(JSON.stringify(data));
        }

        function saveLocalProfile() {
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—É—Ç –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —É–π–¥—É—Ç —Å –∑–∞–∫–∞–∑–æ–º
            console.log("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω");
        }
        
        function loadLocalProfile() {
            // –ï—Å–ª–∏ –±—ã –º—ã —Ö—Ä–∞–Ω–∏–ª–∏ –≤ localStorage, –º—ã –±—ã –ø–æ–¥–≥—Ä—É–∑–∏–ª–∏ —ç—Ç–æ —Ç—É—Ç
        }

        // –ó–∞–ø—É—Å–∫
        init();

    </script>
</body>
</html>
