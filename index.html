<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Catalog</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=6498971d-b2a3-4b9e-8265-7de3ff4dcaf9" type="text/javascript"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #D4AF37; /* –ó–æ–ª–æ—Ç–æ–π/–ü—Ä–µ–º–∏—É–º */
            --secondary-text: #a0a0a0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --blur-strength: 8px; /* –°–∏–ª–∞ —Ä–∞–∑–º—ã—Ç–∏—è –¥–ª—è —Ü–µ–Ω –¥–∏–ª–µ—Ä–∞ */
        }

        /* --- –í–ï–°–¨ –¢–í–û–ô CSS –ò–ó "–°–ê–ô–¢ 2" –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        .header {
            padding: 20px 15px; font-size: 24px; font-weight: 800;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }

        #city-selector { font-size: 14px; font-weight: 400; color: var(--accent-color); cursor: pointer; }

        .categories-scroll {
            display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .categories-scroll::-webkit-scrollbar { display: none; }

        .category-chip {
            padding: 8px 16px; background: var(--card-bg); border-radius: 20px;
            white-space: nowrap; font-size: 14px; border: 1px solid #333; transition: all 0.2s;
        }
        .category-chip.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); font-weight: 600; }

        .product-card {
            background: var(--card-bg); margin: 15px; border-radius: 15px;
            overflow: hidden; border: 1px solid #333; position: relative;
        }
        .product-img { width: 100%; height: 200px; object-fit: cover; background: #252525; }
        .product-info { padding: 15px; }
        .product-price { font-size: 18px; font-weight: 700; color: var(--accent-color); margin: 10px 0; }
        .dealer-badge {
            position: absolute; top: 10px; right: 10px; background: var(--accent-color);
            color: #000; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 800;
        }
        .dealer-only { filter: blur(var(--blur-strength)); pointer-events: none; opacity: 0.6; }

        .btn-main {
            background: var(--accent-color); color: #000; border: none;
            padding: 12px; border-radius: 10px; font-weight: 700; width: 100%; cursor: pointer;
        }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px); display: flex; justify-content: space-around;
            padding: 10px 0; border-top: 1px solid #333; z-index: 1000;
        }
        .nav-item { text-align: center; color: var(--secondary-text); font-size: 12px; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--accent-color); }

        .view { display: none; }
        .view.active { display: block; }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –¢–û–õ–¨–ö–û –î–õ–Ø –ö–ê–†–¢–´ (–î–û–ë–ê–í–õ–ï–ù–´ –í –ö–û–ù–ï–¶) --- */
        #map-wrapper { margin: 15px; border-radius: 15px; overflow: hidden; border: 1px solid #333; height: 250px; }
        #map { width: 100%; height: 100%; }
        .address-box { padding: 15px; background: var(--card-bg); margin: 0 15px; border-radius: 10px; border: 1px dashed var(--accent-color); font-size: 13px; }
    </style>
</head>
<body>

    <div class="header">
        <span>ARMOTEK</span>
        <div id="city-selector" onclick="switchTab('profile-view')">–ú–æ—Å–∫–≤–∞ ‚ñº</div>
    </div>

    <div id="catalog-filters" class="categories-scroll">
        <div class="category-chip active" onclick="filterCategory('all', this)">–í—Å–µ</div>
        <div class="category-chip" onclick="filterCategory('–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è', this)">–ê–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è</div>
        <div class="category-chip" onclick="filterCategory('—Ç–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è', this)">–¢–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è</div>
        <div class="category-chip" onclick="filterCategory('–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', this)">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
    </div>

    <div id="catalog-view" class="view active">
        <div id="catalog-list"></div>
    </div>

    <div id="cart-view" class="view">
        <div style="padding: 15px;">
            <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cart-items"></div>
            <div id="cart-total" style="margin-top:20px; border-top:1px solid #333; padding-top:15px;"></div>
            <button class="btn-main" style="margin-top:20px" onclick="checkout()">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
        </div>
    </div>

    <div id="profile-view" class="view">
        <div style="padding: 15px;">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞</h2>
            <div id="profile-info" class="product-card" style="padding:15px; margin:0 0 15px 0">
                <p>–°—Ç–∞—Ç—É—Å: <span id="profile-status" style="color:var(--accent-color); font-weight:bold">–†–æ–∑–Ω–∏—á–Ω—ã–π</span></p>
                <p>–í–∞—à –≥–æ—Ä–æ–¥: <span id="profile-city">–ú–æ—Å–∫–≤–∞</span></p>
            </div>

            <p style="font-size: 14px; color: var(--secondary-text)">–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ:</p>
            <div class="address-box">
                üìç <span id="current-addr-val">–ê–¥—Ä–µ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
            <div id="map-wrapper">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('catalog-view', this)">üì¶ –ö–∞—Ç–∞–ª–æ–≥</div>
        <div class="nav-item" onclick="switchTab('cart-view', this)">üõí –ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="nav-item" onclick="switchTab('profile-view', this)">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        // --- –î–ê–ù–ù–´–ï –ò–ó –¢–í–û–ï–ì–û "–°–ê–ô–¢ 2" ---
        let tg = window.Telegram.WebApp;
        tg.expand();

        let userProfile = {
            isDealer: false,
            city: "–ú–æ—Å–∫–≤–∞",
            address: "", // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π
            userId: tg.initDataUnsafe?.user?.id || 0
        };

        const products = [
            { id: 1, name: "NAR PPF H190", category: "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è", price: 55000, dealerPrice: 48000, img: "https://armotek.pro/wp-content/uploads/2023/05/h190.jpg" },
            { id: 2, name: "NAR PPF H190 (–æ—Ç—Ä–µ–∑)", category: "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è", price: 3800, dealerPrice: 3200, img: "https://armotek.pro/wp-content/uploads/2023/05/h190.jpg" },
            { id: 3, name: "NAR PPF H210", category: "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è", price: 62000, dealerPrice: 54000, img: "https://armotek.pro/wp-content/uploads/2023/05/h210.jpg" },
            { id: 4, name: "NAR PPF Matte", category: "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è", price: 65000, dealerPrice: 57000, img: "https://armotek.pro/wp-content/uploads/2023/05/matte.jpg" },
            { id: 5, name: "–í—ã–≥–æ–Ω–∫–∞ Blue Max", category: "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", price: 1200, dealerPrice: 950, img: "https://armotek.pro/wp-content/uploads/2023/05/tool1.jpg" }
        ];

        let cart = [];
        let myMap;

        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢–´ (–ù–û–í–û–ï, –ù–ï –ú–ï–ù–Ø–ï–¢ –°–¢–ê–†–´–ô –ö–û–î) ---
        ymaps.ready(function() {
            myMap = new ymaps.Map("map", {
                center: [55.76, 37.64],
                zoom: 10,
                controls: ['geolocationControl']
            });

            myMap.events.add('click', function (e) {
                const coords = e.get('coords');
                ymaps.geocode(coords).then(function (res) {
                    const obj = res.geoObjects.get(0);
                    const addr = obj.getAddressLine();
                    const city = obj.getLocalities()[0] || "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";

                    userProfile.address = addr;
                    userProfile.city = city;

                    document.getElementById('current-addr-val').innerText = addr;
                    document.getElementById('profile-city').innerText = city;
                    document.getElementById('city-selector').innerText = city + ' ‚ñº';
                    
                    myMap.geoObjects.removeAll();
                    myMap.geoObjects.add(new ymaps.Placemark(coords, {balloonContent: addr}));
                });
            });
        });

        // --- –í–°–ï –¢–í–û–ò –§–£–ù–ö–¶–ò–ò –ò–ó "–°–ê–ô–¢ 2" (addToCart, renderCatalog, renderCart –∏ —Ç.–¥.) ---
        function init() {
            renderCatalog();
            updateProfileUI();
        }

        function renderCatalog(filter = 'all') {
            const list = document.getElementById('catalog-list');
            list.innerHTML = '';
            products.forEach(p => {
                if (filter !== 'all' && p.category !== filter) return;
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    ${userProfile.isDealer ? '<div class="dealer-badge">–î–ò–õ–ï–†</div>' : ''}
                    <img src="${p.img}" class="product-img">
                    <div class="product-info">
                        <div style="font-weight:700; font-size:16px;">${p.name}</div>
                        <div class="product-price">${userProfile.isDealer ? p.dealerPrice : p.price} ‚ÇΩ</div>
                        <button class="btn-main" onclick="addToCart(${p.id})">–í –ö–û–†–ó–ò–ù–£</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const exists = cart.find(x => x.id === id);
            if (exists) exists.qty++;
            else cart.push({...p, qty: 1});
            tg.HapticFeedback.impactOccurred('light');
        }

        function switchTab(viewId, navEl) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // –¢–í–û–Ø –õ–û–ì–ò–ö–ê –°–ö–†–´–¢–ò–Ø –≠–õ–ï–ú–ï–ù–¢–û–í
            document.getElementById('catalog-filters').style.display = viewId === 'catalog-view' ? 'flex' : 'none';
            document.getElementById('city-selector').style.display = viewId === 'catalog-view' ? 'block' : 'none';

            if (navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }

            if (viewId === 'profile-view' && myMap) {
                myMap.container.fitToViewport();
            }
            if (viewId === 'cart-view') renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = cart.length === 0 ? '<p style="color:var(--secondary-text)">–ü—É—Å—Ç–æ</p>' : '';
            let total = 0;
            cart.forEach(item => {
                const price = userProfile.isDealer ? item.dealerPrice : item.price;
                total += price * item.qty;
                const div = document.createElement('div');
                div.className = 'product-card';
                div.style.display = 'flex'; div.style.padding = '10px'; div.style.alignItems = 'center';
                div.innerHTML = `<div style="flex:1">${item.name} (${item.qty} —à—Ç)</div><div>${price * item.qty} ‚ÇΩ</div>`;
                container.appendChild(div);
            });
            document.getElementById('cart-total').innerHTML = `<h3>–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ</h3>`;
        }

        function updateProfileUI() {
            document.getElementById('profile-status').innerText = userProfile.isDealer ? "–î–ò–õ–ï–†" : "–†–û–ó–ù–ò–ß–ù–´–ô";
            document.getElementById('profile-city').innerText = userProfile.city;
        }

        // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô CHECKOUT –î–õ–Ø –ü–ï–†–ï–î–ê–ß–ò –ê–î–†–ï–°–ê
        function checkout() {
            if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
            if (!userProfile.address) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ!");
                switchTab('profile-view', document.querySelectorAll('.nav-item')[2]);
                return;
            }

            const orderData = {
                items: cart,
                address: userProfile.address,
                city: userProfile.city,
                total: cart.reduce((s, i) => s + ((userProfile.isDealer ? i.dealerPrice : i.price) * i.qty), 0)
            };

            tg.sendData(JSON.stringify(orderData));
            tg.close();
        }

        init();
    </script>
</body>
</html>
