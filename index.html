<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* ================= –ù–ê–°–¢–†–û–ô–ö–ò –î–û–°–¢–ê–í–ö–ò ================= */

    const DELIVERY_RULES = {
        bigOrder: {
            maxUrgentRolls: 2,
            maxUrgentMeters: 15
        }
    };

    /* ================= –î–ê–ù–ù–´–ï ================= */

    const products = [
        { id: 1, brand: 'NAR', name: '–ù190', unit: '—Ä—É–ª.', price: '$$$' },
        { id: 2, brand: 'NAR', name: '–ù190 (–æ—Ç—Ä–µ–∑)', unit: '–º.', price: '$$' },
        { id: 3, brand: 'Crystal', name: 'Crystal Premium 215', unit: '—Ä—É–ª.', price: '$$$' },
        { id: 4, brand: 'Crystal', name: 'Crystal Matte', unit: '—Ä—É–ª.', price: '$$$' },
        { id: 5, brand: 'NAR', name: '–õ–æ–±–∞—à', unit: '—Ä—É–ª.', price: '$$$' },
        { id: 6, brand: 'NAR', name: '–¶–≤–µ—Ç–Ω–∞—è –ø–ª–µ–Ω–∫–∞', unit: '—Ä—É–ª.', price: '$$$' }
    ];

    let cart = [];
    let userProfile = { city: '–ú–æ—Å–∫–≤–∞', name: '', phone: '' };

    /* ================= INIT ================= */

    function init() {
        renderCatalog('all');

        const saved = localStorage.getItem('armotek_profile');
        if (saved) {
            userProfile = JSON.parse(saved);
            document.getElementById('profile-name').innerText = userProfile.name || '–ì–æ—Å—Ç—å';
            document.getElementById('profile-city').innerText = userProfile.city;
            document.getElementById('addr-city').value = userProfile.city;
            document.getElementById('cust-name').value = userProfile.name || '';
            document.getElementById('cust-phone').value = userProfile.phone || '';
        }

        document.getElementById('city-selector').innerText = userProfile.city + ' ‚ñº';
    }

    /* ================= –ö–ê–¢–ê–õ–û–ì ================= */

    function filterBrand(brand, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderCatalog(brand);
    }

    function renderCatalog(filter) {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';

        products.forEach(p => {
            if (filter !== 'all' && p.brand !== filter) return;

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-img"></div>
                <div class="card-body">
                    <div>
                        <h4 class="card-title">${p.name}</h4>
                        <span class="card-price">${p.brand}</span>
                    </div>
                    <button class="add-btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    /* ================= –ö–û–†–ó–ò–ù–ê ================= */

    function addToCart(id) {
        const prod = products.find(p => p.id === id);
        const existing = cart.find(i => i.id === id);

        if (existing) existing.qty++;
        else cart.push({ ...prod, qty: 1 });

        tg.HapticFeedback?.impactOccurred('light');
        renderCart();
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';

        if (cart.length === 0) {
            container.innerHTML = '<div class="empty-cart"><h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üõí</h3></div>';
            document.getElementById('checkout-btn').style.display = 'none';
            return;
        }

        document.getElementById('checkout-btn').style.display = 'block';

        cart.forEach((item, idx) => {
            const el = document.createElement('div');
            el.className = 'cart-item';
            el.innerHTML = `
                <div>
                    <b>${item.name}</b><br>
                    <small>${item.brand}</small>
                </div>
                <div class="qty-control">
                    <button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button>
                    <span>${item.qty} ${item.unit}</span>
                    <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function updateQty(idx, change) {
        cart[idx].qty += change;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
        renderCart();
    }

    /* ================= –£–ú–ù–ê–Ø –î–û–°–¢–ê–í–ö–ê ================= */

    function isBigOrder() {
        let rolls = 0;
        let meters = 0;

        cart.forEach(item => {
            if (item.unit.includes('—Ä—É–ª')) rolls += item.qty;
            if (item.unit.includes('–º')) meters += item.qty;
        });

        return (
            rolls > DELIVERY_RULES.bigOrder.maxUrgentRolls ||
            meters > DELIVERY_RULES.bigOrder.maxUrgentMeters
        );
    }

    function isMoscowDelivery() {
        return document.getElementById('addr-city').value === '–ú–æ—Å–∫–≤–∞';
    }

    function hasAvailableSlots(date) {
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        const hour = now.getHours();
        const day = date.getDay();

        if (!isToday) return true;
        if (day === 6) return hour < 14;
        return hour < 18;
    }

    function populateDates() {
        const select = document.getElementById('del-date');
        select.innerHTML = '';

        const now = new Date();
        const days = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

        for (let i = 0; i < 7; i++) {
            const d = new Date();
            d.setDate(now.getDate() + i);

            const day = d.getDay();
            if (day === 0) continue;
            if (i === 0 && !hasAvailableSlots(d)) continue;

            const opt = document.createElement('option');
            opt.value = d.toISOString().split('T')[0];
            opt.text = `${days[day]}, ${d.getDate()}.${d.getMonth() + 1}`;
            select.appendChild(opt);
        }

        updateTimeSlots();
    }

    function updateTimeSlots() {
        const dateStr = document.getElementById('del-date').value;
        const timeSelect = document.getElementById('del-time');
        timeSelect.innerHTML = '';

        if (!dateStr) return;

        if (!isMoscowDelivery()) {
            timeSelect.add(new Option('–ü–µ—Ä–µ–¥–∞—á–∞ –≤ –¢–ö (–≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è)', 'tk'));
            return;
        }

        const selectedDate = new Date(dateStr);
        const now = new Date();
        const isToday = selectedDate.toDateString() === now.toDateString();
        const day = selectedDate.getDay();
        const hour = now.getHours();
        const bigOrder = isBigOrder();

        if (day === 6) {
            if (!isToday || hour < 13) {
                timeSelect.add(new Option('10:00 ‚Äì 15:00', '10-15'));
            }
            return;
        }

        if (!isToday || hour < 10) {
            timeSelect.add(new Option('10:00 ‚Äì 14:00', '10-14'));
        }

        if ((!isToday || hour < 14) && !bigOrder) {
            timeSelect.add(new Option('14:00 ‚Äì 18:00', '14-18'));
        }

        if (isToday && hour < 15 && !bigOrder) {
            timeSelect.add(new Option('‚ö° –°—Ä–æ—á–Ω–æ (—Å–µ–≥–æ–¥–Ω—è)', 'urgent'));
        }
    }

    function updateProfileCity(city) {
        userProfile.city = city;
        localStorage.setItem('armotek_profile', JSON.stringify(userProfile));
        document.getElementById('city-selector').innerText = city + ' ‚ñº';
        document.getElementById('profile-city').innerText = city;
        updateTimeSlots();
    }

    init();
</script>
