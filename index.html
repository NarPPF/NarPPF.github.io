<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Catalog</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=776970988-8344409363" type="text/javascript"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #D4AF37; /* –ó–æ–ª–æ—Ç–æ–π */
            --secondary-text: #a0a0a0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --blur-strength: 8px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* –¢–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω */
        .header { padding: 20px; text-align: center; border-bottom: 1px solid #333; }
        .header h1 { margin: 0; font-size: 22px; letter-spacing: 2px; color: var(--accent-color); text-transform: uppercase; }

        .view { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #2c2c2c; }
        .product-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--accent-color); }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .btn { background: var(--accent-color); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .qty-btn { background: #333; color: white; border: 1px solid #444; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; }

        /* –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ô –ë–õ–û–ö –ö–ê–†–¢–´ (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) */
        #map-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 99999;
        }
        #map-canvas { width: 100%; height: 65%; }
        .map-ui { padding: 20px; background: var(--card-bg); height: 35%; border-top: 2px solid var(--accent-color); text-align: center; }
        .map-address-text { color: var(--accent-color); font-size: 14px; margin-bottom: 15px; min-height: 40px; }
        
        /* –¢–∞–±—ã (–ù–∏–∂–Ω–µ–µ –º–µ–Ω—é) */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; padding: 10px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; font-size: 12px; color: var(--secondary-text); }
        .nav-item.active { color: var(--accent-color); }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="header"><h1>ARMOTEK</h1></div>

    <div id="catalog-view" class="view active">
        <div id="product-list"></div>
    </div>

    <div id="cart-view" class="view">
        <h2 style="color:var(--accent-color)">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        <div id="cart-items"></div>
        <div class="card">
            <div style="margin-bottom:10px;">üìç <b>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</b></div>
            <div id="display-address" style="color:var(--secondary-text); margin-bottom:10px;">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <button class="btn" onclick="openMap()">–í–´–ë–†–ê–¢–¨ –ù–ê –ö–ê–†–¢–ï</button>
        </div>
        <div id="cart-total" style="font-size:20px; text-align:right; margin:20px 0;"></div>
        <button class="btn" style="background:var(--success); color:white; height:60px; font-size:18px;" onclick="sendOrder()">–ó–ê–ö–ê–ó–ê–¢–¨</button>
    </div>

    <div id="map-overlay">
        <div id="map-canvas"></div>
        <div class="map-ui">
            <div style="color:#fff; margin-bottom:5px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –º–µ—Ç–∫—É –Ω–∞ –≤–∞—à –∞–¥—Ä–µ—Å:</div>
            <div id="map-address-preview" class="map-address-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="btn" onclick="confirmMapLocation()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –¢–û–ß–ö–£</button>
            <div onclick="closeMap()" style="color:#666; margin-top:15px; font-size:14px;">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('catalog-view', this)"><span>üì¶ –ö–∞—Ç–∞–ª–æ–≥</span></div>
        <div class="nav-item" onclick="switchTab('cart-view', this)"><span>üõí –ö–æ—Ä–∑–∏–Ω–∞</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let products = [
            { id: 1, name: "NAR PPF H190", price: 15500, desc: "–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –ø–æ–ª–∏—É—Ä–µ—Ç–∞–Ω 190 –º–∏–∫—Ä–æ–Ω" },
            { id: 2, name: "NAR PPF H210", price: 18200, desc: "–¢–æ–ª—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ 210 –º–∏–∫—Ä–æ–Ω" },
            { id: 3, name: "NAR PPF Matte", price: 17000, desc: "–ú–∞—Ç–æ–≤—ã–π —Ñ–∏–Ω–∏—à" }
        ];

        let cart = {};
        let userAddress = "";
        let myMap, myPlacemark;

        function init() {
            const list = document.getElementById('product-list');
            list.innerHTML = products.map(p => `
                <div class="card">
                    <div class="product-title">${p.name}</div>
                    <div style="color:var(--secondary-text); font-size:13px;">${p.desc}</div>
                    <div class="price-row">
                        <span style="font-weight:bold; font-size:18px;">${p.price} ‚ÇΩ/–º</span>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQty(${p.id}, -1)">-</button>
                            <span id="qty-${p.id}">0</span>
                            <button class="qty-btn" onclick="updateQty(${p.id}, 1)">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateQty(id, delta) {
            cart[id] = (cart[id] || 0) + delta;
            if (cart[id] <= 0) delete cart[id];
            document.getElementById(`qty-${id}`).innerText = cart[id] || 0;
            tg.HapticFeedback.impactOccurred('light');
        }

        function switchTab(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            el.classList.add('active');
            if(viewId === 'cart-view') renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            let total = 0;
            let html = '';
            for (let id in cart) {
                const p = products.find(i => i.id == id);
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>${p.name} x${cart[id]}</span>
                            <span>${p.price * cart[id]} ‚ÇΩ</span>
                         </div>`;
                total += p.price * cart[id];
            }
            container.innerHTML = html || '<div style="color:#666">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
            document.getElementById('cart-total').innerText = `–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`;
        }

        /* –õ–û–ì–ò–ö–ê –ö–ê–†–¢–´ */
        function openMap() {
            document.getElementById('map-overlay').style.display = 'block';
            if (!myMap) {
                ymaps.ready(() => {
                    myMap = new ymaps.Map("map-canvas", { center: [55.75, 37.62], zoom: 16, controls: [] });
                    myPlacemark = new ymaps.Placemark(myMap.getCenter(), {}, { preset: 'islands#goldIcon', draggable: true });
                    myMap.geoObjects.add(myPlacemark);

                    const updateLabel = (coords) => {
                        ymaps.geocode(coords).then(res => {
                            let addr = res.geoObjects.get(0).getAddressLine();
                            document.getElementById('map-address-preview').innerText = addr;
                            userAddress = addr;
                        });
                    };

                    myPlacemark.events.add('dragend', () => updateLabel(myPlacemark.geometry.getCoordinates()));
                    myMap.events.add('click', (e) => {
                        let c = e.get('coords');
                        myPlacemark.geometry.setCoordinates(c);
                        updateLabel(c);
                    });
                    updateLabel(myMap.getCenter());
                });
            }
        }

        function closeMap() { document.getElementById('map-overlay').style.display = 'none'; }

        function confirmMapLocation() {
            if (userAddress) {
                document.getElementById('display-address').innerText = userAddress;
                closeMap();
            }
        }

        function sendOrder() {
            if (Object.keys(cart).length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
            if (!userAddress) return alert("–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ!");

            let total = 0;
            let cartItems = [];
            for (let id in cart) {
                const p = products.find(i => i.id == id);
                cartItems.push({ name: p.name, qty: cart[id] });
                total += p.price * cart[id];
            }

            const order = { cart: cartItems, address: userAddress, total: total };
            tg.sendData(JSON.stringify(order));
        }

        init();
    </script>
</body>
</html>
