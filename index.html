<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>NAR PPF Admin</title>
<style>
body {
  font-family: Inter, Arial;
  background: #f2f4f7;
  padding: 20px;
}
h1 { margin-bottom: 20px; }
.card {
  background: #fff;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}
input {
  width: 100%;
  padding: 6px;
}
button {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  background: #000;
  color: #fff;
  cursor: pointer;
}
button:hover { opacity: 0.85; }
</style>
</head>
<body>

<h1>NAR PPF ‚Äî –ê–¥–º–∏–Ω–∫–∞</h1>

<div class="card">
<h3>–ö–∞—Ç–∞–ª–æ–≥</h3>
<table id="catalog"></table>
</div>

<div class="card">
<h3>–ü—Ä–∞–π—Å—ã</h3>
<div id="prices"></div>
</div>

<div class="card">
<h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
<table id="users"></table>
</div>

<button onclick="save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

<script>
const token = new URLSearchParams(location.search).get("token");
let catalog = {}, prices = {}, users = {};

async function loadData() {
  const r = await fetch(`/admin/data?token=${token}`);
  const d = await r.json();
  catalog = d.catalog;
  prices = d.prices;
  users = d.users;
  render();
}

function render() {
  const c = document.getElementById("catalog");
  c.innerHTML = "<tr><th>–ö–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th></tr>";
  for (let k in catalog) {
    const p = catalog[k];
    c.innerHTML += `
      <tr>
        <td>${k}</td>
        <td><input value="${p.name}" onchange="catalog['${k}'].name=this.value"></td>
        <td><input type="checkbox" ${p.active ? "checked" : ""} onchange="catalog['${k}'].active=this.checked"></td>
      </tr>`;
  }

  const pr = document.getElementById("prices");
  pr.innerHTML = "";
  for (let t in prices) {
    pr.innerHTML += `<h4>${t}</h4>`;
    for (let k in prices[t]) {
      pr.innerHTML += `${k}: <input type="number" value="${prices[t][k]}"
        onchange="prices['${t}']['${k}']=+this.value"><br>`;
    }
  }

  const u = document.getElementById("users");
  u.innerHTML = "<tr><th>ID</th><th>–ü—Ä–∞–π—Å</th></tr>";
  for (let id in users) {
    u.innerHTML += `
      <tr>
        <td>${id}</td>
        <td><input value="${users[id].price_type || ''}"
        onchange="users['${id}'].price_type=this.value"></td>
      </tr>`;
  }
}

async function save() {
  for (const file of ["catalog.json", "prices.json", "users.json"]) {
    await fetch(`/admin/save?token=${token}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        file: file,
        content: file === "catalog.json" ? catalog :
                 file === "prices.json" ? prices : users
      })
    });
  }
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

loadData();
</script>

</body>
</html>
