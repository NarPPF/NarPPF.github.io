<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Catalog</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=6498971d-b2a3-4b9e-8265-7de3ff4dcaf9" type="text/javascript"></script>

    <style>
        /* –¢–í–û–ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #D4AF37;
            --secondary-text: #a0a0a0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --blur-strength: 8px;
        }

        /* –¢–í–û–ò –°–¢–ò–õ–ò (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        .header {
            padding: 20px 15px; font-size: 24px; font-weight: 800;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }

        #city-selector { font-size: 14px; font-weight: 400; color: var(--accent-color); cursor: pointer; }

        /* –¢–í–û–ò –ö–ê–¢–ï–ì–û–†–ò–ò –ò –§–ò–õ–¨–¢–†–´ */
        .categories-scroll {
            display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .categories-scroll::-webkit-scrollbar { display: none; }
        .category-chip {
            padding: 8px 16px; background: var(--card-bg); border-radius: 20px;
            white-space: nowrap; font-size: 14px; border: 1px solid #333;
        }
        .category-chip.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }

        /* –ö–ê–†–¢–û–ß–ö–ò –¢–û–í–ê–†–û–í (–¢–í–û–ò) */
        .product-card {
            background: var(--card-bg); margin: 15px; border-radius: 15px;
            overflow: hidden; border: 1px solid #333; position: relative;
        }
        .dealer-only { filter: blur(var(--blur-strength)); pointer-events: none; opacity: 0.6; }

        /* –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø 2: –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–´ */
        #map-container { margin: 10px 0; border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        #map { width: 100%; height: 250px; background: #222; }
        .address-info-block {
            background: rgba(212, 175, 55, 0.1); border: 1px solid var(--accent-color);
            padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 14px;
        }

        /* –¢–í–û–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px); display: flex; justify-content: space-around;
            padding: 10px 0; border-top: 1px solid #333; z-index: 1000;
        }
        .nav-item { text-align: center; color: var(--secondary-text); font-size: 12px; flex: 1; }
        .nav-item.active { color: var(--accent-color); }
    </style>
</head>
<body>

    <div class="header">
        <span>ARMOTEK</span>
        <div id="city-selector">–ú–æ—Å–∫–≤–∞ ‚ñº</div>
    </div>

    <div id="catalog-filters" class="categories-scroll">
        <div class="category-chip active" onclick="filterCategory('all', this)">–í—Å–µ</div>
        <div class="category-chip" onclick="filterCategory('–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è', this)">–ê–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è</div>
        <div class="category-chip" onclick="filterCategory('—Ç–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è', this)">–¢–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è</div>
        <div class="category-chip" onclick="filterCategory('–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', this)">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
    </div>

    <div id="catalog-view" class="view active">
        <div id="catalog-list"></div>
    </div>

    <div id="cart-view" class="view">
        <h2 style="padding: 0 15px;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div id="cart-items"></div>
        <div id="cart-summary" style="padding: 15px;"></div>
        <div style="padding: 15px;">
            <button class="btn-main" style="width:100%; padding: 15px; background: var(--accent-color); border:none; border-radius:10px; font-weight:bold;" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <div id="profile-view" class="view">
        <h2 style="padding: 0 15px;">–ü—Ä–æ—Ñ–∏–ª—å –∏ –î–æ—Å—Ç–∞–≤–∫–∞</h2>
        <div style="padding: 0 15px;">
            <div class="address-info-block">
                <strong>üìç –í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å:</strong><br>
                <span id="current-address-text">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –Ω–∏–∂–µ...</span>
            </div>
            
            <div id="map-container">
                <div id="map"></div>
            </div>

            <div style="margin-top:20px; background: var(--card-bg); padding: 15px; border-radius: 10px;">
                <p>–°—Ç–∞—Ç—É—Å: <span id="profile-status" style="color:var(--accent-color)">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                <p>–ì–æ—Ä–æ–¥: <span id="profile-city-name">–ù–µ –≤—ã–±—Ä–∞–Ω</span></p>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('catalog-view', this)">üì¶ –ö–∞—Ç–∞–ª–æ–≥</div>
        <div class="nav-item" onclick="switchTab('cart-view', this)">üõí –ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="nav-item" onclick="switchTab('profile-view', this)">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –¢–í–û–ò –î–ê–ù–ù–´–ï –ü–†–û–§–ò–õ–Ø + –ü–û–õ–ï –ê–î–†–ï–°–ê
        let userProfile = {
            isDealer: false,
            city: "–ú–æ—Å–∫–≤–∞",
            address: "",
            userId: tg.initDataUnsafe?.user?.id || 0
        };

        // –¢–í–û–ò –¢–û–í–ê–†–´ (–ü–†–ò–ú–ï–†, –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö)
        const products = [
            { id: 1, name: "NAR PPF H190", category: "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è", price: 55000, dealerPrice: 48000, img: "https://via.placeholder.com/300x200" },
            { id: 2, name: "NAR PPF Matte", category: "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏–π–Ω–∞—è", price: 62000, dealerPrice: 54000, img: "https://via.placeholder.com/300x200" }
        ];

        let cart = JSON.parse(localStorage.getItem('cart') || '[]');

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ (–ù–û–í–û–ï)
        let myMap;
        ymaps.ready(function() {
            myMap = new ymaps.Map("map", {
                center: [55.76, 37.64],
                zoom: 10,
                controls: ['geolocationControl', 'searchControl']
            });

            myMap.events.add('click', function (e) {
                const coords = e.get('coords');
                ymaps.geocode(coords).then(function (res) {
                    const obj = res.geoObjects.get(0);
                    const addr = obj.getAddressLine();
                    const city = obj.getLocalities()[0] || "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";

                    userProfile.address = addr;
                    userProfile.city = city;

                    document.getElementById('current-address-text').innerText = addr;
                    document.getElementById('profile-city-name').innerText = city;
                    document.getElementById('city-selector').innerText = city + ' ‚ñº';
                });
            });
        });

        // –¢–í–û–ò –§–£–ù–ö–¶–ò–ò –ö–ê–¢–ê–õ–û–ì–ê (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
        function renderCatalog(filter = 'all') {
            const list = document.getElementById('catalog-list');
            list.innerHTML = '';
            products.forEach(p => {
                if (filter !== 'all' && p.category !== filter) return;
                
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${p.img}" style="width:100%">
                    <div style="padding:15px">
                        <h3>${p.name}</h3>
                        <p>–¶–µ–Ω–∞: ${p.price} ‚ÇΩ</p>
                        <button onclick="addToCart(${p.id})" style="width:100%; padding:10px; background:var(--accent-color); border:none; border-radius:5px;">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function filterCategory(cat, el) {
            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderCatalog(cat);
        }

        // –¢–í–û–Ø –§–£–ù–ö–¶–ò–Ø –°–ú–ï–ù–´ –í–ö–õ–ê–î–û–ö + –§–ò–ö–° –î–õ–Ø –ö–ê–†–¢–´
        function switchTab(viewId, navEl) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // –¢–í–û–Ø –õ–û–ì–ò–ö–ê –°–ö–†–´–¢–ò–Ø –§–ò–õ–¨–¢–†–û–í
            const filters = document.getElementById('catalog-filters');
            filters.style.display = viewId === 'catalog-view' ? 'flex' : 'none';

            if (navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }

            // –§–ò–ö–°: –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–æ—Ñ–∏–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É, –∏–Ω–∞—á–µ –æ–Ω–∞ –±—É–¥–µ—Ç —Å–µ—Ä–æ–π
            if (viewId === 'profile-view' && myMap) {
                myMap.container.fitToViewport();
            }
            
            if (viewId === 'cart-view') renderCart();
        }

        // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô CHECKOUT (–ë–ï–†–ï–¢ –ê–î–†–ï–° –ò–ó –ö–ê–†–¢–´)
        function checkout() {
            if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
            if (!userProfile.address) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ!");
                switchTab('profile-view', document.querySelectorAll('.nav-item')[2]);
                return;
            }

            const orderData = {
                cart: cart,
                address: userProfile.address,
                city: userProfile.city,
                total: cart.reduce((s, i) => s + (i.price * i.qty), 0)
            };

            tg.sendData(JSON.stringify(orderData));
            tg.close();
        }

        // –ó–ê–ü–£–°–ö
        renderCatalog();
        document.getElementById('profile-status').innerText = userProfile.isDealer ? "–î–∏–ª–µ—Ä" : "–†–æ–∑–Ω–∏—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç";

    </script>
</body>
</html>
