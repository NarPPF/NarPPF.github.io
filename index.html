<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=776970988-YOUR-KEY" type="text/javascript"></script>
    
    <style>
        :root { --accent: #D4AF37; --bg: #000; --card: #111; --text: #fff; --green: #28a745; }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            margin: 0; padding-bottom: 90px; overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* HEADER */
        .app-bar { 
            display: flex; align-items: center; padding: 15px; 
            background: rgba(0,0,0,0.95); border-bottom: 1px solid #222; 
            position: sticky; top: 0; z-index: 1000; height: 50px;
        }
        .back-btn { background: none; border: none; color: var(--accent); font-size: 24px; display: none; padding-right: 15px; cursor: pointer; }
        .back-btn.visible { display: block; }
        .page-title { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }

        /* VIEWS */
        .view { display: none; padding: 15px; animation: fadeIn 0.2s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & UI */
        .card { background: var(--card); border-radius: 14px; padding: 14px; margin-bottom: 12px; border: 1px solid #222; position: relative; }
        .main-btn { 
            background: var(--accent); color: #000; width: 100%; padding: 16px; 
            border-radius: 12px; font-weight: 700; border: none; cursor: pointer; font-size: 16px;
            transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { opacity: 0.5; filter: grayscale(1); }
        
        input { 
            width: 100%; padding: 14px; background: #1a1a1a; color: #fff; 
            border: 1px solid #333; border-radius: 10px; margin-top: 5px; 
            box-sizing: border-box; font-size: 16px; outline: none;
        }
        input:focus { border-color: var(--accent); }

        /* QTY CONTROLS */
        .qty-control {
            display: flex; align-items: center; justify-content: space-between;
            background: #222; border-radius: 8px; width: 100px; padding: 5px;
        }
        .qty-btn {
            width: 30px; height: 30px; border-radius: 6px; border: none;
            background: #333; color: #fff; font-weight: bold; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .qty-btn:active { background: var(--accent); color: #000; }
        .qty-val { font-weight: bold; font-size: 15px; width: 30px; text-align: center; }

        .add-btn-initial {
            background: #222; color: var(--accent); border: 1px solid var(--accent);
            padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        /* TOAST NOTIFICATION */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #222; color: #fff;
            text-align: center; border-radius: 50px; padding: 12px; position: fixed;
            z-index: 9999; left: 50%; bottom: 80px; transform: translateX(-50%);
            font-size: 14px; border: 1px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }

        /* MAP STYLES */
        #map-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; }
        .map-header { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; background: rgba(0,0,0,0.9); z-index: 5002; box-sizing: border-box; }
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 5001; }
        .map-footer { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to top, #000 90%, transparent); z-index: 5002; display: flex; gap: 10px; box-sizing: border-box; }

        /* NAVIGATION */
        .nav-bottom { 
            position: fixed; bottom: 0; width: 100%; display: flex; 
            background: #0a0a0a; border-top: 1px solid #222; 
            padding-bottom: env(safe-area-inset-bottom); z-index: 1000;
        }
        .nav-item { flex: 1; padding: 12px; text-align: center; color: #555; background: none; border: none; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* ORDERS HISTORY */
        .order-badge { 
            background: #222; color: #888; padding: 4px 8px; border-radius: 4px; 
            font-size: 11px; text-transform: uppercase; float: right; 
        }
        .order-badge.new { color: var(--accent); border: 1px solid var(--accent); }
    </style>
</head>
<body>

    <div class="app-bar">
        <button id="back-btn" class="back-btn" onclick="goBack()">‚ùÆ</button>
        <div id="page-title" class="page-title">–ö–∞—Ç–∞–ª–æ–≥</div>
    </div>

    <div id="catalog-view" class="view active">
        <div id="products-grid"></div>
    </div>

    <div id="cart-view" class="view">
        <div id="cart-list"></div>
        <div id="order-form" style="display:none; margin-top:20px;">
            <div class="card">
                <label style="color:var(--accent); font-size:12px; font-weight:bold;">–ê–î–†–ï–° –î–û–°–¢–ê–í–ö–ò</label>
                <div onclick="openMap()" style="margin-top:10px; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                    <span id="display-addr" style="color:#aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ...</span>
                    <span>üó∫</span>
                </div>
            </div>
            <button id="order-btn" class="main-btn" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <div id="profile-view" class="view">
        <div class="card">
            <h3>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <label style="font-size:12px; color:#888;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="u-phone" placeholder="+7..." onchange="saveLocalProfile()">
            <label style="font-size:12px; color:#888; display:block; margin-top:10px;">–ì–æ—Ä–æ–¥</label>
            <input type="text" id="u-city" placeholder="–û–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ –∫–∞—Ä—Ç–µ" readonly style="color:#888;">
        </div>

        <div class="card">
            <h3 style="margin-bottom:10px;">üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
            <div id="orders-history-list">
                <div style="text-align:center; padding:10px; color:#555; font-size:13px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
            </div>
        </div>
    </div>

    <div id="map-overlay">
        <div class="map-header">
            <div style="display:flex; gap:10px;">
                <input type="text" id="map-search-input" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º..." style="margin:0;">
                <button onclick="searchOnMap()" style="background:var(--accent); border:none; border-radius:10px; width:50px; font-weight:bold;">üîç</button>
            </div>
        </div>
        <div id="map"></div>
        <div class="map-footer">
            <button onclick="closeMap(false)" style="flex:1; background:#222; color:#fff; border:none; padding:15px; border-radius:12px; font-weight:bold;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="closeMap(true)" style="flex:2; background:var(--accent); color:#000; border:none; padding:15px; border-radius:12px; font-weight:bold;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>

    <nav class="nav-bottom">
        <button class="nav-item active" onclick="navigate('catalog-view')">
            <span class="nav-icon">üè†</span>–ö–∞—Ç–∞–ª–æ–≥
        </button>
        <button class="nav-item" onclick="navigate('cart-view')">
            <span class="nav-icon">üõí</span>–ö–æ—Ä–∑–∏–Ω–∞ <span id="cart-badge" style="display:none; color:var(--accent)">‚Ä¢</span>
        </button>
        <button class="nav-item" onclick="navigate('profile-view')">
            <span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å
        </button>
    </nav>

    <div id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // –î–∞–Ω–Ω—ã–µ
        const products = [
            {id: 1, name: "Armotek Onyx (1.52m)", price: 15900, img: ""},
            {id: 2, name: "Armotek Matte (1.52m)", price: 17200, img: ""},
            {id: 3, name: "–†–∞–∫–µ–ª—å Carbon", price: 2500, img: ""},
            {id: 4, name: "–ù–æ–∂ –¥–ª—è —Ä–µ–∑–∫–∏ (Pro)", price: 800, img: ""}
        ];

        let cart = {}; // Object: id -> qty
        let stack = ['catalog-view'];
        let selectedAddress = "";
        let mapInstance = null;
        let mapPlacemark = null;

        // --- –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï ---
        function formatPrice(p) { return p.toLocaleString('ru-RU') + " ‚ÇΩ"; }

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        function showToast(msg) {
            const el = document.getElementById("toast");
            el.innerText = msg;
            el.className = "show";
            setTimeout(() => { el.className = el.className.replace("show", ""); }, 2500);
        }

        // --- –ö–ê–¢–ê–õ–û–ì ---
        function renderCatalog() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = products.map(p => {
                const qty = cart[p.id] || 0;
                
                // –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–∫–∏: –ª–∏–±–æ "–í –∫–æ—Ä–∑–∏–Ω—É", –ª–∏–±–æ –∫–æ–Ω—Ç—Ä–æ–ª "+ 1 -"
                let btnHtml = '';
                if (qty === 0) {
                    btnHtml = `<button class="add-btn-initial" onclick="updateQty(${p.id}, 1)">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>`;
                } else {
                    btnHtml = `
                        <div class="qty-control">
                            <button class="qty-btn" onclick="updateQty(${p.id}, -1)">‚àí</button>
                            <span class="qty-val">${qty}</span>
                            <button class="qty-btn" onclick="updateQty(${p.id}, 1)">+</button>
                        </div>
                    `;
                }

                return `
                <div class="card" style="display:flex; gap:15px; align-items:center;">
                    <div style="width:60px; height:60px; background:#222; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#444; font-size:10px;">IMG</div>
                    <div style="flex:1;">
                        <div style="font-weight:700; font-size:15px; margin-bottom:4px;">${p.name}</div>
                        <div style="color:var(--accent); font-weight:500;">${formatPrice(p.price)}</div>
                    </div>
                    <div>${btnHtml}</div>
                </div>`;
            }).join('');
        }

        function updateQty(id, delta) {
            if (!cart[id]) cart[id] = 0;
            cart[id] += delta;
            if (cart[id] <= 0) delete cart[id];
            
            tg.HapticFeedback.selectionChanged();
            
            // –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –ø–æ–∫–∞–∂–µ–º —Ç–æ—Å—Ç
            if (cart[id] === 1 && delta === 1) {
                const p = products.find(x => x.id === id);
                showToast(`–î–æ–±–∞–≤–ª–µ–Ω: ${p.name}`);
            }

            renderCatalog();
            updateCartBadge();
        }

        function updateCartBadge() {
            const hasItems = Object.keys(cart).length > 0;
            document.getElementById('cart-badge').style.display = hasItems ? 'inline' : 'none';
        }

        // --- –ö–û–†–ó–ò–ù–ê ---
        function renderCartView() {
            const list = document.getElementById('cart-list');
            const form = document.getElementById('order-form');
            const ids = Object.keys(cart);

            if (ids.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:60px; color:#555;'>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>";
                form.style.display = 'none';
                return;
            }

            let total = 0;
            let html = ids.map(id => {
                const p = products.find(x => x.id == id);
                const q = cart[id];
                const sum = p.price * q;
                total += sum;
                return `
                <div style="border-bottom:1px solid #222; padding:12px 0; display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:14px;">${p.name}</div>
                        <div style="color:#666; font-size:12px;">${q} x ${formatPrice(p.price)}</div>
                    </div>
                    <div style="font-weight:bold; color:#fff;">${formatPrice(sum)}</div>
                    <button onclick="updateQty(${id}, -${q}); renderCartView()" style="background:none; border:none; color:#555; padding:0 0 0 15px; font-size:18px;">‚úï</button>
                </div>`;
            }).join('');

            html += `<div style="text-align:right; padding-top:20px; font-size:18px; font-weight:bold;">
                        <span style="color:#888; font-size:14px; margin-right:10px;">–ò–¢–û–ì–û:</span> 
                        <span style="color:var(--accent)">${formatPrice(total)}</span>
                     </div>`;

            list.innerHTML = html;
            form.style.display = 'block';
        }

        // --- –ö–ê–†–¢–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê) ---
        function openMap() {
            document.getElementById('map-overlay').style.display = 'block';
            if (!mapInstance) {
                ymaps.ready(() => {
                    mapInstance = new ymaps.Map("map", {
                        center: [55.75, 37.62], zoom: 11,
                        controls: ['zoomControl', 'geolocationControl']
                    });
                    mapInstance.events.add('click', e => setMarker(e.get('coords')));
                });
            }
        }

        function setMarker(coords) {
            if (mapPlacemark) mapInstance.geoObjects.remove(mapPlacemark);
            mapPlacemark = new ymaps.Placemark(coords, {}, { draggable: true, preset: 'islands#yellowIcon' });
            
            mapPlacemark.events.add('dragend', () => getAddr(mapPlacemark.geometry.getCoordinates()));
            mapInstance.geoObjects.add(mapPlacemark);
            getAddr(coords);
        }

        function getAddr(coords) {
            document.getElementById('map-search-input').value = "–ü–æ–∏—Å–∫...";
            ymaps.geocode(coords).then(res => {
                const obj = res.geoObjects.get(0);
                const addr = obj.getAddressLine();
                document.getElementById('map-search-input').value = addr;
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥–æ—Ä–æ–¥ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
                const locs = obj.getLocalities();
                if(locs.length > 0) localStorage.setItem('user_city', locs[0]);
            });
        }

        function searchOnMap() {
            const txt = document.getElementById('map-search-input').value;
            if(!txt) return;
            ymaps.geocode(txt).then(res => {
                const obj = res.geoObjects.get(0);
                if(obj) {
                    const coords = obj.geometry.getCoordinates();
                    mapInstance.setCenter(coords, 15);
                    setMarker(coords);
                }
            });
        }

        function closeMap(save) {
            document.getElementById('map-overlay').style.display = 'none';
            if (save) {
                // –í–ê–ñ–ù–û: –ë–µ—Ä–µ–º —Ç–æ, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤ INPUT, –∞ –Ω–µ —Ç–æ, —á—Ç–æ –¥–∞–ª–∞ –∫–∞—Ä—Ç–∞
                // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –¥–æ–ø–∏—Å–∞—Ç—å "–ø–æ–¥—ä–µ–∑–¥ 5" —Ä—É–∫–∞–º–∏
                const manualInput = document.getElementById('map-search-input').value;
                selectedAddress = manualInput;
                
                const displayEl = document.getElementById('display-addr');
                displayEl.innerText = selectedAddress;
                displayEl.style.color = "#fff";

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª–µ, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –Ω–∞–π–¥–µ–Ω
                const city = localStorage.getItem('user_city');
                if(city) document.getElementById('u-city').value = city;
            }
        }

        // --- –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í (–õ–û–ö–ê–õ–¨–ù–ê–Ø) ---
        function loadOrders() {
            const hist = JSON.parse(localStorage.getItem('orders_hist') || '[]');
            const container = document.getElementById('orders-history-list');
            if (hist.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:10px; color:#555; font-size:13px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                return;
            }
            container.innerHTML = hist.map(o => `
                <div style="border-bottom:1px solid #222; padding:10px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:bold; font-size:13px;">–ó–∞–∫–∞–∑ #${o.id.substr(-4)}</span>
                        <span class="order-badge new">${o.status}</span>
                    </div>
                    <div style="font-size:11px; color:#888;">${o.date} ‚Ä¢ ${formatPrice(o.total)}</div>
                    <div style="font-size:11px; color:#666; margin-top:3px;">${o.addr}</div>
                </div>
            `).join('');
        }

        function saveOrderLocal(total) {
            const hist = JSON.parse(localStorage.getItem('orders_hist') || '[]');
            hist.unshift({
                id: Date.now().toString(),
                date: new Date().toLocaleDateString(),
                total: total,
                addr: selectedAddress,
                status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
            });
            localStorage.setItem('orders_hist', JSON.stringify(hist));
        }

        // --- –û–¢–ü–†–ê–í–ö–ê ---
        function sendOrder() {
            if (!selectedAddress) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å!");
            
            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º cart object –≤ array –¥–ª—è –±–æ—Ç–∞
            const cartArr = Object.keys(cart).map(id => {
                const p = products.find(x => x.id == id);
                return { ...p, qty: cart[id] };
            });

            const total = cartArr.reduce((sum, x) => sum + (x.price * x.qty), 0);

            saveOrderLocal(total);

            tg.sendData(JSON.stringify({
                cart: cartArr,
                total: total,
                address: selectedAddress,
                phone: document.getElementById('u-phone').value
            }));
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function navigate(id) {
            if (id === 'cart-view') renderCartView();
            if (id === 'profile-view') loadOrders();
            
            stack.push(id);
            updateView();
        }
        
        function goBack() {
            if (stack.length > 1) { stack.pop(); updateView(); }
        }

        function updateView() {
            const cur = stack[stack.length - 1];
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(cur).classList.add('active');
            
            document.getElementById('back-btn').classList.toggle('visible', stack.length > 1);
            
            const titles = {'catalog-view':'–ö–∞—Ç–∞–ª–æ–≥', 'cart-view':'–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ', 'profile-view':'–ü—Ä–æ—Ñ–∏–ª—å'};
            document.getElementById('page-title').innerText = titles[cur];

            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.toggle('active', b.getAttribute('onclick').includes(cur));
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('products-grid').innerHTML = "Loading...";
        setTimeout(renderCatalog, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        
        // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        if(localStorage.getItem('user_city')) document.getElementById('u-city').value = localStorage.getItem('user_city');

    </script>
</body>
</html>
