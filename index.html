<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Armotek Catalog</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #D4AF37;
            --secondary-text: #a0a0a0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --blur-strength: 8px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            user-select: none;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ (—Å—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏–ª) */
        .container { padding: 16px; }
        .product-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .price { color: var(--accent-color); font-weight: bold; font-size: 1.1em; }
        
        .btn {
            background: var(--accent-color);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å–Ω–∏–∑—É */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
        }
        
        .nav-item { color: var(--secondary-text); text-align: center; font-size: 0.8em; cursor: pointer; }
        .nav-item.active { color: var(--accent-color); }
    </style>
</head>
<body>

    <div id="catalog-view" class="view active">
        <div class="container">
            <h2 id="role-title">–ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏</h2>
            <div id="product-list"></div>
        </div>
    </div>

    <div id="cart-view" class="view">
        <div class="container">
            <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cart-items"></div>
            <hr>
            <div id="order-form">
                <input type="text" id="cust-name" placeholder="–í–∞—à–µ –∏–º—è" style="width:100%; margin-bottom:10px; padding:8px;">
                <input type="text" id="cust-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" style="width:100%; margin-bottom:10px; padding:8px;">
                <button class="btn" style="width:100%" onclick="submitOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('catalog-view', this)">–ö–∞—Ç–∞–ª–æ–≥</div>
        <div class="nav-item" onclick="switchTab('cart-view', this)">–ö–æ—Ä–∑–∏–Ω–∞ (<span id="cart-count">0</span>)</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ë–õ–û–ö D: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –†–û–õ–ò –ò–ó URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const isDealer = urlParams.get('isDealer') === 'true';

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
        document.getElementById('role-title').innerText = isDealer ? 'üíé –î–∏–ª–µ—Ä—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥' : 'üì¶ –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏';

        const products = [
            { id: 101, name: "NAR PPF H190", retail: 45000, dealer: 38000, unit: "—Ä—É–ª." },
            { id: 102, name: "NAR PPF H190 (–æ—Ç—Ä–µ–∑)", retail: 3500, dealer: 2900, unit: "–ø–æ–≥.–º." },
            { id: 103, name: "NAR PPF H210", retail: 52000, dealer: 45000, unit: "—Ä—É–ª." }
        ];

        let cart = [];

        function renderProducts() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            products.forEach(p => {
                // –ë–õ–û–ö A3: –¶–ï–ù–ê –í–´–ë–ò–†–ê–ï–¢–°–Ø –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –†–û–õ–ò
                const price = isDealer ? p.dealer : p.retail;
                list.innerHTML += `
                    <div class="product-card">
                        <div>
                            <strong>${p.name}</strong><br>
                            <span class="price">${price.toLocaleString()} ‚ÇΩ / ${p.unit}</span>
                        </div>
                        <button class="btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>
                `;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const inCart = cart.find(x => x.id === id);
            if (inCart) {
                inCart.qty++;
            } else {
                cart.push({ ...p, qty: 1 });
            }
            updateCartCount();
        }

        function updateCartCount() {
            document.getElementById('cart-count').innerText = cart.reduce((a, b) => a + b.qty, 0);
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if (cart.length === 0) {
                container.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
                return;
            }
            container.innerHTML = cart.map(item => {
                const price = isDealer ? item.dealer : item.retail;
                return `<div>${item.name} x ${item.qty} = ${(price * item.qty).toLocaleString()} ‚ÇΩ</div>`;
            }).join('<br>');
        }

        function switchTab(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if (viewId === 'cart-view') renderCart();
        }

        // --- –ë–õ–û–ö A2 & A3: –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê ---
        function submitOrder() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;

            if (!name || !phone || cart.length === 0) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã!");
                return;
            }

            const payload = {
                order: {
                    cart: cart.map(i => ({ id: i.id, qty: i.qty })),
                    customer: { name, phone }
                },
                _auth: tg.initData // –ü–ï–†–ï–î–ê–ï–ú –î–ê–ù–ù–´–ï –î–õ–Ø –í–ê–õ–ò–î–ê–¶–ò–ò
            };

            if (tg.initData) {
                tg.sendData(JSON.stringify(payload));
                tg.close();
            } else {
                alert("–û—à–∏–±–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞");
            }
        }

        renderProducts();
    </script>
</body>
</html>
