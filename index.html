<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NarPPF Catalog</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #ffffff;
            --accent-color: #D4AF37; --secondary-text: #a0a0a0;
            --danger: #e74c3c; --success: #2ecc71;
        }
        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding-bottom: 90px; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .header { padding: 15px; background: var(--card-bg); position: sticky; top: 0; z-index: 100; text-align: center; }
        .logo { font-size: 20px; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
        .filters { display: flex; justify-content: center; gap: 8px; overflow-x: auto; padding: 5px; }
        .filter-btn {
            background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color);
            padding: 6px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer;
        }
        .filter-btn.active { background: var(--accent-color); color: #000; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: var(--card-bg); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .card-body { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; min-height: 32px; }
        
        .control-group { display: flex; align-items: center; justify-content: space-between; background: #333; border-radius: 6px; height: 32px; }
        .btn-mini { width: 32px; height: 100%; border: none; background: transparent; color: white; font-size: 18px; cursor: pointer; }
        .add-btn { background: var(--accent-color); border: none; width: 100%; height: 32px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); display: flex; padding: 10px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: var(--secondary-text); font-size: 10px; position: relative; cursor: pointer; }
        .nav-item.active { color: var(--accent-color); }
        #cart-badge { position: absolute; top: -5px; right: 20%; background: var(--danger); color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; display: none; }

        .view { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: var(--secondary-text); margin-bottom: 5px; }
        input, select, textarea { width: 100%; background: #333; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .main-btn { background: var(--accent-color); color: #000; width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        
        .history-item { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; border-left: 3px solid var(--accent-color); }
        
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; display: none; z-index: 3000; border: 1px solid var(--accent-color); }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="catalog-header">
    <div class="header">
        <div class="logo">NarPPF</div>
        <div class="filters">
            <button class="filter-btn active" onclick="filterBrand('all', this)">–í—Å–µ</button>
            <button class="filter-btn" onclick="filterBrand('NAR', this)">NAR PPF</button>
            <button class="filter-btn" onclick="filterBrand('Crystal', this)">Crystal</button>
            <button class="filter-btn" onclick="filterBrand('Tools', this)">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</button>
        </div>
    </div>
</div>

<div id="catalog-view" class="view active">
    <div class="grid" id="product-grid"></div>
</div>

<div id="cart-view" class="view">
    <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
    <div id="cart-items"></div>
    <div id="cart-total" style="text-align: right; font-weight: bold; margin-top: 15px; color: var(--accent-color); font-size: 18px;"></div>
    <button class="main-btn" onclick="startCheckout()" id="btn-to-checkout">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button class="main-btn" style="background:#333; color:white;" onclick="tab('catalog-view', document.querySelector('.nav-item'))">–ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥</button>
</div>

<div id="checkout-view" class="view">
    <h3 id="step-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
    <div id="step-1">
        <div class="form-group"><label>–í–∞—à–µ –∏–º—è</label><input type="text" id="c-name"></div>
        <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="c-phone" value="+7"></div>
        <button class="main-btn" onclick="goStep(2)">–î–∞–ª–µ–µ</button>
    </div>
    <div id="step-2" style="display:none">
        <div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="c-city"></div>
        <div class="form-group"><label>–ê–¥—Ä–µ—Å / –ü–í–ó</label><input type="text" id="c-addr"></div>
        <button class="main-btn" onclick="finishOrder()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
</div>

<div id="profile-view" class="view">
    <h3>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
    <div class="history-item" id="user-info-display"></div>
    <h4>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h4>
    <div id="order-history"></div>
    <button class="main-btn" style="background:#0088cc; color:white;" onclick="contactManager()">üí¨ –°–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</button>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="tab('catalog-view', this)"><span>üìÇ</span><br>–ö–∞—Ç–∞–ª–æ–≥</div>
    <div class="nav-item" onclick="tab('cart-view', this)"><span id="cart-badge">0</span><span>üõí</span><br>–ö–æ—Ä–∑–∏–Ω–∞</div>
    <div class="nav-item" onclick="tab('profile-view', this)"><span>üë§</span><br>–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const products = [
        { id: "nar_h190", brand: 'NAR', name: 'NAR PPF H190', retail: 45000 },
        { id: "nar_matte", brand: 'NAR', name: 'NAR PPF Matte', retail: 48000 },
        { id: "crys_215", brand: 'Crystal', name: 'Crystal Premium', retail: 28000 },
        { id: "tool_sq", brand: 'Tools', name: '–†–∞–∫–µ–ª—å NarPPF', retail: 500 }
    ];

    let cart = {};
    let profile = JSON.parse(localStorage.getItem('narppf_user') || '{"name":"","phone":"+7","city":"","addr":"","history":[]}');

    // –õ–æ–≥–∏–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –ù–µ –¥–∞–µ–º —Å—Ç–∏—Ä–∞—Ç—å +7
    const phoneInput = document.getElementById('c-phone');
    phoneInput.addEventListener('input', function(e) {
        if (!this.value.startsWith('+7')) this.value = '+7';
        this.value = '+' + this.value.replace(/\D/g, '');
    });

    function init() {
        document.getElementById('c-name').value = profile.name;
        document.getElementById('c-phone').value = profile.phone || '+7';
        document.getElementById('c-city').value = profile.city;
        document.getElementById('c-addr').value = profile.addr;
        renderCatalog();
        updateBadge();
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2500);
    }

    function renderCatalog(f = 'all') {
        const g = document.getElementById('product-grid');
        g.innerHTML = '';
        products.forEach(p => {
            if (f !== 'all' && p.brand !== f) return;
            const q = cart[p.id] || 0;
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div style="height:100px; background:#222; display:flex; align-items:center; justify-content:center; font-size:12px; color:#555; font-weight:bold">${p.brand}</div>
                <div class="card-body">
                    <div class="card-title">${p.name}</div>
                    <div style="color:var(--accent-color); font-size:14px; margin-bottom:10px; font-weight:bold">${p.retail.toLocaleString()} ‚ÇΩ</div>
                    <div id="btn-container-${p.id}">
                        ${q > 0 ? renderControls(p.id, q) : `<button class="add-btn" onclick="upd('${p.id}', 1)">–í –∫–æ—Ä–∑–∏–Ω—É</button>`}
                    </div>
                </div>`;
            g.appendChild(div);
        });
    }

    function renderControls(id, q) {
        return `<div class="control-group">
            <button class="btn-mini" onclick="upd('${id}', -1)">-</button>
            <span style="font-weight:bold">${q}</span>
            <button class="btn-mini" onclick="upd('${id}', 1)">+</button>
        </div>`;
    }

    function upd(id, delta) {
        cart[id] = (cart[id] || 0) + delta;
        if (cart[id] <= 0) delete cart[id];
        
        const container = document.getElementById(`btn-container-${id}`);
        if (container) {
            const q = cart[id] || 0;
            container.innerHTML = q > 0 ? renderControls(id, q) : `<button class="add-btn" onclick="upd('${id}', 1)">–í –∫–æ—Ä–∑–∏–Ω—É</button>`;
        }
        updateBadge();
        tg.HapticFeedback.impactOccurred('light');
    }

    function updateBadge() {
        const total = Object.values(cart).reduce((a, b) => a + b, 0);
        const b = document.getElementById('cart-badge');
        b.innerText = total; b.style.display = total > 0 ? 'block' : 'none';
    }

    function renderCart() {
        const c = document.getElementById('cart-items');
        c.innerHTML = '';
        let sum = 0;
        const keys = Object.keys(cart);
        if(keys.length === 0) {
            c.innerHTML = '<p style="text-align:center; color:#555">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
            document.getElementById('btn-to-checkout').style.display = 'none';
        } else {
            document.getElementById('btn-to-checkout').style.display = 'block';
            keys.forEach(id => {
                const p = products.find(x => x.id === id);
                const q = cart[id];
                sum += p.retail * q;
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; margin-bottom:10px; background:#222; padding:12px; border-radius:8px;";
                div.innerHTML = `<div>${p.name}<br><small style="color:#777">${p.retail} ‚ÇΩ</small></div><div style="color:var(--accent-color)"><b>${q} —à—Ç.</b></div>`;
                c.appendChild(div);
            });
        }
        document.getElementById('cart-total').innerText = sum.toLocaleString() + ' ‚ÇΩ';
    }

    function renderProfile() {
        const info = document.getElementById('user-info-display');
        info.innerHTML = profile.name ? `<b>${profile.name}</b><br>${profile.phone}` : '–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã';
        
        const hist = document.getElementById('order-history');
        hist.innerHTML = profile.history.length ? '' : '<p style="color:#555">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        profile.history.slice().reverse().forEach(ord => {
            const d = document.createElement('div');
            d.className = 'history-item';
            d.innerHTML = `<b>–ó–∞–∫–∞–∑ –æ—Ç ${ord.date}</b><br>${ord.summary}<br>–ò—Ç–æ–≥–æ: ${ord.total} ‚ÇΩ`;
            hist.appendChild(d);
        });
    }

    function tab(v, el) {
        document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
        document.getElementById(v).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('catalog-header').style.display = (v === 'catalog-view') ? 'block' : 'none';
        if (v === 'cart-view') renderCart();
        if (v === 'profile-view') renderProfile();
    }

    function startCheckout() {
        if (Object.keys(cart).length === 0) return showToast("–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã");
        tab('checkout-view', document.querySelectorAll('.nav-item')[1]);
        goStep(1);
    }

    function goStep(n) {
        document.getElementById('step-1').style.display = n === 1 ? 'block' : 'none';
        document.getElementById('step-2').style.display = n === 2 ? 'block' : 'none';
        document.getElementById('step-title').innerText = n === 1 ? "–ö–æ–Ω—Ç–∞–∫—Ç—ã" : "–î–æ—Å—Ç–∞–≤–∫–∞";
    }

    function finishOrder() {
        const name = document.getElementById('c-name').value;
        const phone = document.getElementById('c-phone').value;
        if (!name || phone.length < 10) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã");

        const items = Object.keys(cart).map(id => {
            const p = products.find(x => x.id === id);
            return { id: id, name: p.name, qty: cart[id], price: p.retail };
        });

        const totalSum = items.reduce((s, i) => s + (i.price * i.qty), 0);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        profile.name = name;
        profile.phone = phone;
        profile.city = document.getElementById('c-city').value;
        profile.addr = document.getElementById('c-addr').value;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        const orderRecord = {
            date: new Date().toLocaleDateString(),
            total: totalSum.toLocaleString(),
            summary: items.map(i => `${i.name} (${i.qty})`).join(', ')
        };
        profile.history.push(orderRecord);
        localStorage.setItem('narppf_user', JSON.stringify(profile));

        const orderData = {
            version: 1,
            source: "NarPPF",
            cart: items,
            customer: { name, phone, city: profile.city, addr: profile.addr }
        };

        tg.HapticFeedback.notificationOccurred('success');
        tg.sendData(JSON.stringify(orderData));
    }

    function contactManager() {
        tg.openTelegramLink("https://t.me/HappyHangman");
    }

    function filterBrand(b, btn) {
        document.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active'));
        btn.classList.add('active');
        renderCatalog(b);
    }

    init();
</script>
</body>
</html>
